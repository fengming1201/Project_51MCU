C51 COMPILER V9.00   COMMRTOS                                                              10/19/2015 09:58:27 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE COMMRTOS
OBJECT MODULE PLACED IN COMMRTOS.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE COMMRTOS.C LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2          *********************************************************************************************************
   3          *                                               uC/OS-II
   4          *                                               实时内核
   5          *
   6          *                        (c) Copyright 1992-1998, Jean J. Labrosse, Plantation, FL
   7          *                                               版权所有
   8          *
   9          *                                            MCU-51 专用代码
  10          *                                           KEIL C51大模式编译
  11          *
  12          * 文件名 : SERIAL.C
  13          * 作者   : Jean J. Labrosse
  14          * 改编   : 杨屹 gdtyy@ri.gdt.com.cn 巨龙公司系统集成开发部 2002.09.27
  15          *********************************************************************************************************
  16          */
  17          
  18          //**********************************************************************************
  19          //杨屹    2002/08/20    第一版
  20          //基于中断的串口驱动及显示程序
  21          //联系方法：gdtyy@ri.gdt.com.cn（2003/07/31以前有效）
  22          //**********************************************************************************
  23          //程序特点：
  24          //        1.基于中断，可并发执行
  25          //        2.参数可配置（收发缓冲区大小，最大字符串长度，TAB键移动距离）
  26          //**********************************************************************************
  27          //使用方法：（此范例自包含，独立于其他程序。）
  28          //        先配制收发缓冲区大小等可变参数（在serial.h中的宏定义）
  29          //        1.开头加入#include <reg51.h>语句，一定要有。
  30          //        2.初始化串口        InitSerial();//本例中为20MHz晶体，300波特率，模式2初始化
  31          //        3.初始化串口缓冲区  InitSerialBuffer();
  32          //        4.使用显示字节，字，长字，字符，字符串，清屏函数。
  33          //自包含
  34          //**********************************************************************************
  35          //波特率计算公式：
  36          //        TH1=256-(2^SMOD/32*Fosc/12*1/Bound)
  37          //    其中：SMOD=0，1；Fosc=晶体或晶振频率；Bound=波特率
  38          //    本例中，SMOD=0；Fosc=20*10E6；Bound=300，所以TH1=0x52。
  39          //Baud rate(20Mhz)
  40          //300(52);1200(D5);2400(EA);4800(F5);9600(FB);19200(FD);38400(FF);
  41          //**********************************************************************************
  42          //书写风格：
  43          //        1.带yy前缀标志的函数为杨屹改写的等效C库函数。
  44          //        2.单个单词用小写，yy定义为前缀，不算一个单词。
  45          //        3.多个单词（2个及以上），每个单词首字母大写。(有时变量名第一个单词首字母小写)
  46          //        4.采用内缩风格，每次缩进8个空格。
  47          //**********************************************************************************
  48          //应用举例：（可在KEIL仿真环境下运行）
  49          //源程序文件：serial.h/serial.c/main.c
  50          //main.c内容：
  51          //#include <reg51.h>//Note:It must be added.必须在serial.c之前
  52          //#include <serial.h>
  53          //main()
  54          //{
  55          //      unsigned char ch;
C51 COMPILER V9.00   COMMRTOS                                                              10/19/2015 09:58:27 PAGE 2   

  56          //
  57          //      InitSerial();
  58          //      InitSerialBuffer();
  59          //      while(1){
  60          //              PrintStr("\n");
  61          //              PrintByte(90);PrintStr(" ");
  62          //              PrintWord(90);PrintStr(" ");
  63          //              PrintLong(90);PrintStr(" ");
  64          //              PrintChar('y');PrintChar(' ');//千万别写成双引号，否则打印0（乱字符）。
  65          //              PrintStr("\nHello!\nI'm YangYi.\n");
  66          //              PrintStr("Press any key to continue...");
  67          //              while(!yygetch(&ch));
  68          //      }
  69          //}
  70          //**********************************************************************************
  71          //建议：
  72          //    你完全可以把该子程序当作函数库使用，以便减少重复劳动，提高代码质量。
  73          //**********************************************************************************
  74          
  75          //#ifndef  OS_MASTER_FILE
  76          #include "includes.h"
*** WARNING C318 IN LINE 31 OF includes.h: can't open file 'AT89X52.H'
  77          //#endif
  78          
  79          unsigned char TxBuf[LenTxBuf],RxBuf[LenRxBuf];//收发缓冲区实体
  80          unsigned char *inTxBuf,*outTxBuf,*inRxBuf,*outRxBuf;//收发缓冲区读写指针
  81          bit TIflag=1;//Note:It must be 1.
  82          
  83          void InitSerial() reentrant//串口初始化
  84          {
  85   1              TMOD=TMOD&0x0F;
*** ERROR C202 IN LINE 85 OF COMMRTOS.C: 'TMOD': undefined identifier
  86   1              TMOD=TMOD|0x20;
*** ERROR C202 IN LINE 86 OF COMMRTOS.C: 'TMOD': undefined identifier
  87   1              TL1=0xF3,TH1=0xF3;//19200 , 22.1184MHz
*** ERROR C202 IN LINE 87 OF COMMRTOS.C: 'TL1': undefined identifier
  88   1              SCON=0x50;PCON=0x00;
*** ERROR C202 IN LINE 88 OF COMMRTOS.C: 'SCON': undefined identifier
*** ERROR C202 IN LINE 88 OF COMMRTOS.C: 'PCON': undefined identifier
  89   1              TR1=1;
*** ERROR C202 IN LINE 89 OF COMMRTOS.C: 'TR1': undefined identifier
  90   1      }
  91          
  92          void InitSerialBuffer(void) reentrant//串口缓冲区初始化
  93          {
  94   1              inTxBuf=TxBuf;outTxBuf=TxBuf;
  95   1              inRxBuf=RxBuf;outRxBuf=RxBuf;
  96   1              ES=1;
*** ERROR C202 IN LINE 96 OF COMMRTOS.C: 'ES': undefined identifier
  97   1              //EA=1;
  98   1      }
  99          
 100          void serial(void) reentrant
 101          {    //中断在汇编中实现，去掉interrupt 4{//串口中断服务子程序
 102   1              unsigned char *t;
 103   1      
 104   1              if(TI){
*** ERROR C202 IN LINE 104 OF COMMRTOS.C: 'TI': undefined identifier
 105   2                      TI=0;
*** ERROR C202 IN LINE 105 OF COMMRTOS.C: 'TI': undefined identifier
 106   2                      if(inTxBuf==outTxBuf) {TIflag=1;return;}//TxBuf Empty
 107   2                      SBUF=*outTxBuf; outTxBuf++;
C51 COMPILER V9.00   COMMRTOS                                                              10/19/2015 09:58:27 PAGE 3   

*** ERROR C202 IN LINE 107 OF COMMRTOS.C: 'SBUF': undefined identifier
 108   2                      if(outTxBuf==TxBuf+LenTxBuf) outTxBuf=TxBuf;    
 109   2              }
 110   1              if(RI){
*** ERROR C202 IN LINE 110 OF COMMRTOS.C: 'RI': undefined identifier
 111   2                      RI=0;
*** ERROR C202 IN LINE 111 OF COMMRTOS.C: 'RI': undefined identifier
 112   2                      t=inRxBuf;t++;
 113   2                      if(t==RxBuf+LenRxBuf) t=RxBuf;
 114   2                      if(t==outRxBuf) return;                 //RxBuf Full
 115   2                      *inRxBuf=SBUF;
*** ERROR C202 IN LINE 115 OF COMMRTOS.C: 'SBUF': undefined identifier
 116   2                      inRxBuf=t;
 117   2              }
 118   1      }
 119          
 120          bit yygetch(unsigned char *ch) reentrant//从串口缓冲区读1字节数据
 121          {
 122   1              //ES=0;        
 123   1              if(inRxBuf==outRxBuf) {ES=1;return 0;}          //RxBuf Empty
*** ERROR C202 IN LINE 123 OF COMMRTOS.C: 'ES': undefined identifier
 124   1              *ch=*outRxBuf;  outRxBuf++;
 125   1              if(outRxBuf==RxBuf+LenRxBuf) outRxBuf=RxBuf;
 126   1              //ES=1;        
 127   1              return 1;
 128   1      }
 129          
 130          void PrintChar(unsigned char ch) reentrant//显示字符
 131          {
 132   1              unsigned char *t;
 133   1      
 134   1              //ES=0;        
 135   1              if(TIflag){             
 136   2                      TIflag=0;
 137   2                      TI=1;
*** ERROR C202 IN LINE 137 OF COMMRTOS.C: 'TI': undefined identifier
 138   2              }
 139   1              t=inTxBuf;t++;
 140   1              if(t==TxBuf+LenTxBuf) t=TxBuf;
 141   1              if(t==outTxBuf) {/*ES=1;*/return;}                  //TxBuf Full
 142   1              *inTxBuf=ch;
 143   1              inTxBuf=t;
 144   1              //ES=1;        
 145   1      }
 146          
 147          void PrintCh(unsigned char ch) reentrant//内部使用，不建议用户看到。
 148          {
 149   1              if(ch>=0&&ch<=9) ch=ch+'0';
 150   1              else ch=ch+'A'-10;
 151   1              PrintChar(ch);
 152   1      }
 153          
 154          void insidePrintByte(unsigned char Byte) reentrant//内部使用，以十六进制格式显示1个字节数据
 155          {
 156   1              unsigned char c;
 157   1              c=Byte;
 158   1              c=c>>4;        
 159   1              PrintCh(c);
 160   1              c=Byte;c=c&0x0F;PrintCh(c);        
 161   1      }
 162          
 163          void PrintByte(unsigned char Byte) reentrant//以十六进制格式显示1个字节数据
C51 COMPILER V9.00   COMMRTOS                                                              10/19/2015 09:58:27 PAGE 4   

 164          {
 165   1              EA=0;        
*** ERROR C202 IN LINE 165 OF COMMRTOS.C: 'EA': undefined identifier
 166   1              insidePrintByte(Byte);                
 167   1              EA=1;
*** ERROR C202 IN LINE 167 OF COMMRTOS.C: 'EA': undefined identifier
 168   1      }
 169          
 170          void insidePrintWord(unsigned int Word) reentrant//内部使用，以十六进制格式显示1个字数据
 171          {               
 172   1              insidePrintByte(Word>>8);
 173   1              insidePrintByte(Word&0xFF);                        
 174   1      }
 175          
 176          void PrintWord(unsigned int Word) reentrant//以十六进制格式显示1个字数据
 177          {       
 178   1              EA=0;
*** ERROR C202 IN LINE 178 OF COMMRTOS.C: 'EA': undefined identifier
 179   1              insidePrintWord(Word);
 180   1              EA=1;
*** ERROR C202 IN LINE 180 OF COMMRTOS.C: 'EA': undefined identifier
 181   1      }
 182          
 183          void PrintLong(unsigned long LongWord) reentrant//以十六进制格式显示1个长字数据
 184          {
 185   1              EA=0;
*** ERROR C202 IN LINE 185 OF COMMRTOS.C: 'EA': undefined identifier
 186   1              insidePrintWord(LongWord>>16);
 187   1              insidePrintWord(LongWord&0xFFFF);
 188   1              EA=1;
*** ERROR C202 IN LINE 188 OF COMMRTOS.C: 'EA': undefined identifier
 189   1      }
 190          
 191          void PrintStr(unsigned char *str) reentrant//显示字符串
 192          {
 193   1              int i;
 194   1              unsigned char j;
 195   1              unsigned char ch;
 196   1              
 197   1              EA=0;
*** ERROR C202 IN LINE 197 OF COMMRTOS.C: 'EA': undefined identifier
 198   1              for(i=0;i<MaxLenStr;i++){
 199   2                      ch=*(str+i);
 200   2                      if(ch=='\0') break;
 201   2                      else if(ch=='\n'){PrintChar(10);PrintChar(13);} 
 202   2                      else if(ch=='\t'){
 203   3                              for(j=0;j<TABNum;j++)
 204   3                                      PrintChar(' ');
 205   3                      }
 206   2                      else PrintChar(ch);
 207   2              }
 208   1              EA=1;
*** ERROR C202 IN LINE 208 OF COMMRTOS.C: 'EA': undefined identifier
 209   1      }
 210          
 211          void clrscr() reentrant//清屏
 212          {        
 213   1              PrintStr("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n");//25个回车换行清屏幕。
 214   1      }

C51 COMPILATION COMPLETE.  1 WARNING(S),  23 ERROR(S)
